<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êñá‰ª∂‰∏ä‰º†Á≥ªÁªü</title>
    <script src="/vue.global.js"></script>
    <link href="/tailwind.min.css" rel="stylesheet">
    <style>
        .upload-area {
            border: 2px dashed #cbd5e0;
            transition: all 0.3s ease;
        }
        .upload-area:hover {
            border-color: #4299e1;
            background-color: #ebf8ff;
        }
        .upload-area.dragover {
            border-color: #3182ce;
            background-color: #bee3f8;
            transform: scale(1.02);
        }
        .file-item {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .progress-bar {
            transition: width 0.3s ease;
        }
        .delete-btn {
            transition: all 0.2s ease;
        }
        .delete-btn:hover {
            transform: scale(1.1);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div id="app">
        <div class="container mx-auto px-4 py-8 max-w-4xl">
            <header class="text-center mb-10">
                <h1 class="text-4xl font-bold text-gray-800 mb-2">üìÅ Êñá‰ª∂‰∏ä‰º†Á≥ªÁªü</h1>
                <p class="text-gray-600">ÊîØÊåÅÊãñÊãΩ‰∏ä‰º†ÔºåÂ§öÊñá‰ª∂ÂêåÊó∂‰∏ä‰º†</p>
            </header>

            <main>
                <!-- ‰∏ä‰º†Âå∫Âüü -->
                <section class="mb-8">
                    <div 
                        class="upload-area bg-white rounded-lg p-12 text-center cursor-pointer shadow-md"
                        :class="{ 'dragover': isDragging }"
                        @drop="handleDrop"
                        @dragover.prevent="handleDragOver"
                        @dragenter="handleDragEnter"
                        @dragleave="handleDragLeave"
                        @click="triggerFileInput"
                    >
                        <input 
                            ref="fileInput"
                            type="file" 
                            multiple 
                            class="hidden" 
                            @change="handleFileSelect"
                        >
                        
                        <div class="mb-4">
                            <svg class="w-16 h-16 mx-auto text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                        </div>
                        
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">
                            {{ isDragging ? 'ÈáäÊîæÊñá‰ª∂‰ª•‰∏ä‰º†' : 'ÁÇπÂáªÊàñÊãñÊãΩÊñá‰ª∂Âà∞ËøôÈáå' }}
                        </h3>
                        <p class="text-gray-500">ÊîØÊåÅÂ§ö‰∏™Êñá‰ª∂ÂêåÊó∂‰∏ä‰º†</p>
                    </div>
                </section>

                <!-- ‰∏ä‰º†ÁªüËÆ° -->
                <section v-if="files.length > 0" class="mb-6 bg-white rounded-lg p-4 shadow">
                    <div class="flex justify-between items-center">
                        <div class="text-sm text-gray-600">
                            <span>ÊÄªÊñá‰ª∂Êï∞: {{ files.length }}</span>
                            <span class="ml-4">Â∑≤‰∏ä‰º†: {{ uploadedCount }}</span>
                            <span class="ml-4">‰∏ä‰º†‰∏≠: {{ uploadingCount }}</span>
                        </div>
                        <button 
                            @click="clearAll"
                            class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600 transition"
                        >
                            Ê∏ÖÁ©∫ÊâÄÊúâ
                        </button>
                    </div>
                </section>

                <!-- Êñá‰ª∂ÂàóË°® -->
                <section v-if="files.length > 0" class="space-y-4">
                    <h2 class="text-2xl font-semibold text-gray-800 mb-4">üìã Êñá‰ª∂ÂàóË°®</h2>
                    
                    <div 
                        v-for="(file, index) in files" 
                        :key="file.id"
                        class="file-item bg-white rounded-lg p-4 shadow hover:shadow-lg transition-shadow"
                    >
                        <div class="flex items-center justify-between">
                            <div class="flex items-center flex-1">
                                <div class="mr-4">
                                    <svg v-if="file.type.startsWith('image/')" class="w-10 h-10 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"></path>
                                    </svg>
                                    <svg v-else-if="file.type.startsWith('video/')" class="w-10 h-10 text-blue-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm3 2h6v4l-2-1.5L9 9V5z" clip-rule="evenodd"></path>
                                    </svg>
                                    <svg v-else-if="file.type.startsWith('audio/')" class="w-10 h-10 text-purple-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path d="M18 3a1 1 0 00-1.196-.98l-10 2A1 1 0 006 5v9.114A4.369 4.369 0 005 14c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V7.82l8-1.6v5.894A4.37 4.37 0 0015 12c-1.657 0-3 .895-3 2s1.343 2 3 2 3-.895 3-2V3z"></path>
                                    </svg>
                                    <svg v-else-if="file.type.includes('pdf')" class="w-10 h-10 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4 4a2 2 0 012-2h4.586A2 2 0 0112 2.586L15.414 6A2 2 0 0116 7.414V16a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <svg v-else class="w-10 h-10 text-gray-500" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" clip-rule="evenodd"></path>
                                        <path fill-rule="evenodd" d="M4 5a2 2 0 012-2v1h8V3a2 2 0 012 2v10a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd"></path>
                                    </svg>
                                </div>
                                
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-800 truncate">{{ file.name }}</h4>
                                    <div class="text-sm text-gray-600 mt-1">
                                        <span>{{ formatFileSize(file.size) }}</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <span>{{ file.type || 'Êú™Áü•Á±ªÂûã' }}</span>
                                        <span class="mx-2">‚Ä¢</span>
                                        <span>{{ formatDate(file.uploadTime) }}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex items-center space-x-2">
                                <!-- ‰∏ä‰º†Áä∂ÊÄÅ -->
                                <div v-if="file.status === 'uploading'" class="flex items-center space-x-2">
                                    <div class="w-24 bg-gray-200 rounded-full h-2">
                                        <div 
                                            class="progress-bar bg-blue-500 h-2 rounded-full"
                                            :style="{ width: file.progress + '%' }"
                                        ></div>
                                    </div>
                                    <span class="text-sm text-gray-600">{{ file.progress }}%</span>
                                </div>
                                
                                <div v-else-if="file.status === 'completed'" class="flex items-center text-green-600">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="ml-1 text-sm">Â∑≤ÂÆåÊàê</span>
                                </div>
                                
                                <div v-else-if="file.status === 'error'" class="flex items-center text-red-600">
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                    </svg>
                                    <span class="ml-1 text-sm">Â§±Ë¥•</span>
                                </div>
                                
                                <!-- Âà†Èô§ÊåâÈíÆ -->
                                <button 
                                    @click="deleteFile(file.savedName || file.name, index)"
                                    class="delete-btn p-2 text-red-500 hover:bg-red-50 rounded-full"
                                    :disabled="file.status === 'uploading'"
                                >
                                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                                        <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path>
                                    </svg>
                                </button>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Á©∫Áä∂ÊÄÅ -->
                <section v-else class="text-center py-12">
                    <svg class="w-24 h-24 mx-auto text-gray-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                    </svg>
                    <p class="text-gray-500 text-lg">ÊöÇÊó†Êñá‰ª∂</p>
                    <p class="text-gray-400 text-sm mt-2">ËØ∑ÈÄâÊã©ÊàñÊãñÊãΩÊñá‰ª∂ÂºÄÂßã‰∏ä‰º†</p>
                </section>
            </main>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    files: [],
                    isDragging: false,
                    fileIdCounter: 0
                };
            },
            computed: {
                uploadedCount() {
                    return this.files.filter(f => f.status === 'completed').length;
                },
                uploadingCount() {
                    return this.files.filter(f => f.status === 'uploading').length;
                }
            },
            methods: {
                triggerFileInput() {
                    this.$refs.fileInput.click();
                },

                handleFileSelect(event) {
                    const selectedFiles = Array.from(event.target.files);
                    this.addFiles(selectedFiles);
                    event.target.value = ''; // Ê∏ÖÁ©∫inputÔºåÂÖÅËÆ∏ÈáçÂ§çÈÄâÊã©Áõ∏ÂêåÊñá‰ª∂
                },

                handleDragOver(event) {
                    event.preventDefault();
                },

                handleDragEnter(event) {
                    event.preventDefault();
                    this.isDragging = true;
                },

                handleDragLeave(event) {
                    event.preventDefault();
                    // Ê£ÄÊü•ÊòØÂê¶ÁúüÁöÑÁ¶ªÂºÄ‰∫ÜÊãñÊãΩÂå∫Âüü
                    if (!event.currentTarget.contains(event.relatedTarget)) {
                        this.isDragging = false;
                    }
                },

                handleDrop(event) {
                    event.preventDefault();
                    this.isDragging = false;
                    
                    const droppedFiles = Array.from(event.dataTransfer.files);
                    this.addFiles(droppedFiles);
                },

                addFiles(newFiles) {
                    newFiles.forEach(file => {
                        const fileObj = {
                            id: ++this.fileIdCounter,
                            file: file,
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            uploadTime: new Date(),
                            status: 'pending',
                            progress: 0,
                            url: null
                        };
                        
                        this.files.push(fileObj);
                        this.uploadFile(fileObj);
                    });
                },

                uploadFile(fileObj) {
                    // Vue 3Áõ¥Êé•ËµãÂÄºÂç≥ÂèØÔºå‰∏çÈúÄË¶Å$set
                    fileObj.status = 'uploading';
                    fileObj.progress = 0;
                    
                    // ËÆæÁΩÆ‰∏Ä‰∏™Â∞èÁöÑÂàùÂßãËøõÂ∫¶ÔºåËÆ©Áî®Êà∑ÁúãÂà∞‰∏ä‰º†ÂºÄÂßã‰∫Ü
                    setTimeout(() => {
                        if (fileObj.status === 'uploading' && fileObj.progress === 0) {
                            fileObj.progress = 5;
                        }
                    }, 100);
                    
                    const formData = new FormData();
                    formData.append('file', fileObj.file);
                    
                    // ‰ΩøÁî®XMLHttpRequestÊù•ÁõëÊéß‰∏ä‰º†ËøõÂ∫¶
                    const xhr = new XMLHttpRequest();
                    
                    // ÁõëÊéß‰∏ä‰º†ËøõÂ∫¶
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percentComplete = (e.loaded / e.total) * 100;
                            fileObj.progress = Math.round(percentComplete);
                        }
                    });
                    
                    // Â§ÑÁêÜÂÆåÊàê
                    xhr.addEventListener('load', () => {
                        if (xhr.status === 200) {
                            const result = JSON.parse(xhr.responseText);
                            fileObj.progress = 100;
                            fileObj.status = 'completed';
                            fileObj.url = result.file.url;
                            fileObj.savedName = result.file.name;
                            this.showNotification(`Êñá‰ª∂ "${fileObj.name}" ‰∏ä‰º†ÊàêÂäüÔºÅ`);
                            this.loadExistingFiles();
                        } else {
                            fileObj.status = 'error';
                            this.showNotification(`Êñá‰ª∂ "${fileObj.name}" ‰∏ä‰º†Â§±Ë¥•`, 'error');
                        }
                    });
                    
                    // Â§ÑÁêÜÈîôËØØ
                    xhr.addEventListener('error', () => {
                        fileObj.status = 'error';
                        this.showNotification(`Êñá‰ª∂ "${fileObj.name}" ‰∏ä‰º†Â§±Ë¥•: ÁΩëÁªúÈîôËØØ`, 'error');
                    });
                    
                    // Â§ÑÁêÜË∂ÖÊó∂
                    xhr.addEventListener('timeout', () => {
                        fileObj.status = 'error';
                        this.showNotification(`Êñá‰ª∂ "${fileObj.name}" ‰∏ä‰º†Ë∂ÖÊó∂`, 'error');
                    });
                    
                    // ËÆæÁΩÆË∂ÖÊó∂Êó∂Èó¥Ôºà10ÂàÜÈíüÔºâ
                    xhr.timeout = 600000;
                    
                    // ÂèëÈÄÅËØ∑Ê±Ç
                    xhr.open('POST', '/api/upload');
                    console.log('ÂºÄÂßã‰∏ä‰º†Êñá‰ª∂:', fileObj.name, 'Â§ßÂ∞è:', fileObj.size);
                    xhr.send(formData);
                },

                async loadExistingFiles() {
                    try {
                        const response = await fetch('/api/files');
                        if (response.ok) {
                            const result = await response.json();
                            // ÂèØ‰ª•Âú®ËøôÈáåÂ§ÑÁêÜÂ∑≤Â≠òÂú®ÁöÑÊñá‰ª∂ÂàóË°®
                            console.log('Â∑≤Â≠òÂú®ÁöÑÊñá‰ª∂:', result.files);
                        }
                    } catch (error) {
                        console.error('Âä†ËΩΩÊñá‰ª∂ÂàóË°®Â§±Ë¥•:', error);
                    }
                },

                createFileURL(file) {
                    // ‰∏∫Êñá‰ª∂ÂàõÂª∫‰∏¥Êó∂URLÁî®‰∫éÈ¢ÑËßà
                    return URL.createObjectURL(file);
                },

                async deleteFile(filename, index) {
                    try {
                        const response = await fetch(`/api/files/${filename}`, {
                            method: 'DELETE'
                        });
                        
                        if (response.ok) {
                            this.files.splice(index, 1);
                            this.showNotification('Êñá‰ª∂Âà†Èô§ÊàêÂäü');
                        } else {
                            throw new Error('Âà†Èô§Â§±Ë¥•');
                        }
                    } catch (error) {
                        this.showNotification(`Âà†Èô§Êñá‰ª∂Â§±Ë¥•: ${error.message}`, 'error');
                    }
                },

                removeFile(index) {
                    const file = this.files[index];
                    if (file.url && file.url.startsWith('blob:')) {
                        URL.revokeObjectURL(file.url); // Ê∏ÖÁêÜ‰∏¥Êó∂URL
                    }
                    this.files.splice(index, 1);
                },

                async clearAll() {
                    if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊñá‰ª∂ÂêóÔºü')) {
                        try {
                            // ÂÖàÊ∏ÖÁ©∫ÊúçÂä°Âô®Êñá‰ª∂
                            const response = await fetch('/api/files', {
                                method: 'DELETE'
                            });
                            
                            if (response.ok) {
                                // Ê∏ÖÁêÜÊâÄÊúâ‰∏¥Êó∂URLÂíåÊú¨Âú∞Êñá‰ª∂ÂàóË°®
                                this.files.forEach(file => {
                                    if (file.url && file.url.startsWith('blob:')) {
                                        URL.revokeObjectURL(file.url);
                                    }
                                });
                                this.files = [];
                                this.showNotification('ÊâÄÊúâÊñá‰ª∂Â∑≤Ê∏ÖÁ©∫');
                            } else {
                                throw new Error('Ê∏ÖÁ©∫Â§±Ë¥•');
                            }
                        } catch (error) {
                            this.showNotification(`Ê∏ÖÁ©∫Êñá‰ª∂Â§±Ë¥•: ${error.message}`, 'error');
                        }
                    }
                },

                formatFileSize(bytes) {
                    if (bytes === 0) return '0 Bytes';
                    
                    const k = 1024;
                    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                    const i = Math.floor(Math.log(bytes) / Math.log(k));
                    
                    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
                },

                formatDate(date) {
                    return new Date(date).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                },

                showNotification(message, type = 'success') {
                    // ÂàõÂª∫ÁÆÄÂçïÁöÑÈÄöÁü•ÊèêÁ§∫
                    const notification = document.createElement('div');
                    const bgColor = type === 'error' ? 'bg-red-500' : 'bg-green-500';
                    notification.className = `fixed top-4 right-4 ${bgColor} text-white px-6 py-3 rounded-lg shadow-lg z-50`;
                    notification.style.animation = 'slideIn 0.3s ease-out';
                    notification.textContent = message;
                    
                    document.body.appendChild(notification);
                    
                    setTimeout(() => {
                        notification.style.animation = 'slideOut 0.3s ease-in';
                        setTimeout(() => {
                            if (document.body.contains(notification)) {
                                document.body.removeChild(notification);
                            }
                        }, 300);
                    }, 3000);
                }
            },

            mounted() {
                // Ê∑ªÂä†Âä®ÁîªÊ†∑Âºè
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes slideOut {
                        to {
                            opacity: 0;
                            transform: translateX(100%);
                        }
                    }
                `;
                document.head.appendChild(style);
                
                // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÂ∑≤Â≠òÂú®ÁöÑÊñá‰ª∂
                this.loadExistingFiles();
            }
        }).mount('#app');
    </script>
</body>
</html>